<!-- <!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body,#map{margin:0;padding:0;height:100%}
    .btn{
      position:absolute;z-index:1000;
      background:#fff5ef;border:1px solid #ff7a3d;color:#d55a1f;
      border-radius:24px;padding:6px 10px;
    }
    #searchHere{top:10px;left:50%;transform:translateX(-50%)}
    #locateMe{
      right:12px;bottom:12px;
      width:40px;height:40px;
      display:flex;align-items:center;justify-content:center;background-color:transparent;
      border: none; 
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="searchHere" class="btn">현 지도에서 검색</button>
  <button id="locateMe" class="btn">
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" 
       viewBox="-2 -2 26 26" fill="none" stroke="#d55a1f" 
       stroke-width="2" >
      <circle cx="12" cy="12" r="10"/>
      <circle cx="12" cy="12" r="5"/>
      <line x1="12" y1="-2" x2="12" y2="2"/>
      <line x1="12" y1="22" x2="12" y2="26"/>
      <line x1="22" y1="12" x2="26" y2="12"/>
      <line x1="-2" y1="12" x2="2" y2="12"/>
    </svg>
  </button>

  <script>
  (function(){
    function post(x){ try{ window.ReactNativeWebView.postMessage(JSON.stringify(x)); }catch(e){} }
    post({ type:'origin', origin: location.origin, href: location.href });

    // URL 파라미터에서 key 읽기
    const urlParams = new URLSearchParams(location.search);
    const ncpKeyId = urlParams.get('ncpKeyId');

    var s=document.createElement('script');
    s.src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=${ncpKeyId}";
    s.onload=function(){ post({ type:'maps', ok:true }); init(); };
    s.onerror=function(){ post({ type:'maps', ok:false }); };
    document.head.appendChild(s);

    var map=null, markers=[], ready=false, queue=[], myMarker=null;

    // ★ 최초 한 번만 내 위치로 센터 맞추기 위한 플래그
    var initialCentered = false;

    // ★ RN 응답이 없을 때 HTML5 geolocation 폴백용 타이머/해제자
    var locateFallbackTimer = null;

    function init(){
      if(!window.naver||!naver.maps){ post({ type:'init', ok:false }); return; }

      // 초기엔 임시 중심(서울 시내)으로 띄워두고
      map = new naver.maps.Map('map',{ center:new naver.maps.LatLng(37.5533,126.9232), zoom:13 });
      ready=true; post({ type:'ready' });

      while(queue.length){ handle(queue.shift()); }

      document.getElementById('searchHere').onclick = function(){
        var b=map.getBounds(), c=map.getCenter();
        post({ type:'searchHere',
          ne:{lat:b.getNE().lat(),lng:b.getNE().lng()},
          sw:{lat:b.getSW().lat(),lng:b.getSW().lng()},
          center:{lat:c.lat(),lng:c.lng()},
          zoom: map.getZoom()
        });
      };

      document.getElementById('locateMe').onclick = function(){
        post({ type:'locate:request' });
      };

      // ★ 페이지 진입 직후 자동으로 내 위치 요청
      post({ type:'locate:request', reason:'init' });

      // ★ RN이 응답 못 주면 1.2초 뒤 HTML5 geolocation으로 폴백 시도
      clearTimeout(locateFallbackTimer);
      locateFallbackTimer = setTimeout(function(){
        if (initialCentered) return;
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(pos){
            handle({
              type:'locate:set',
              lat: pos.coords.latitude,
              lng: pos.coords.longitude,
              accuracy: pos.coords.accuracy
            });
          }, function(err){
            post({ type:'locate:error', source:'html5', code: err.code, message: err.message });
          }, { enableHighAccuracy:true, timeout:5000, maximumAge:10000 });
        }
      }, 1200); // 필요하면 조정
    }

    window.addEventListener('message', function(e){
      var msg; try{ msg=JSON.parse(e.data||'{}'); }catch(_){ return; }
      if(!ready){ queue.push(msg); return; }
      handle(msg);
    });

    function handle(msg){
      if(msg.type==='setMarkers'){
        markers.forEach(m=>m.setMap(null));
        markers = [];

        var baseSvg = msg.pinSvg || null;
        var selSvg  = msg.selectedPinSvg || baseSvg;
        var selId   = msg.selectedId != null ? String(msg.selectedId) : null;

        (msg.data||[]).filter(Boolean).forEach(function(it){
          var icon;
          if(selId && String(it.id)===selId && selSvg){
            icon = {
              content: selSvg,
              size: new naver.maps.Size(28,28),
              anchor: new naver.maps.Point(14,28)
            };
          } else if(baseSvg){
            icon = {
              content: baseSvg,
              size: new naver.maps.Size(28,28),
              anchor: new naver.maps.Point(14,28)
            };
          } else {
            icon = null;
          }

          var m=new naver.maps.Marker({
            position:new naver.maps.LatLng(it.lat,it.lng),
            map,
            title:it.title||'',
            icon: icon || undefined
          });
          naver.maps.Event.addListener(m,'click',()=>post({ type:'marker', id: it.id }));
          markers.push(m);
        });
        post({ type:'setMarkers:done', count: markers.length });

      } else if(msg.type==='setView' && msg.center){
        map.setCenter(new naver.maps.LatLng(msg.center.lat, msg.center.lng));
        if(typeof msg.zoom==='number') map.setZoom(msg.zoom);
        post({ type:'setView:done', center: msg.center, zoom: msg.zoom });

      } else if (msg.type==='locate:set' && typeof msg.lat==='number' && typeof msg.lng==='number'){
        clearTimeout(locateFallbackTimer); // ★ 폴백 대기 중이면 해제

        var ll = new naver.maps.LatLng(msg.lat, msg.lng);

        // ★ 내 위치 마커 표시/업데이트
        if(!myMarker){
          myMarker = new naver.maps.Marker({
            position: ll,
            map,
            icon:{
              content:'<div style="background:#007bff;border-radius:50%;width:14px;height:14px;border:2px solid white;"></div>',
              size:new naver.maps.Size(14,14),
              anchor:new naver.maps.Point(7,7)
            },
            zIndex: 9999
          });
        } else {
          myMarker.setPosition(ll);
        }

        // ★ 최초 한 번만 센터/줌을 내 위치로 고정
        if (!initialCentered) {
          initialCentered = true;
          map.setCenter(ll);
          map.setZoom(15); // 취향대로 조정
          post({ type:'locate:centered', zoom: 15 });
        } else {
          // 이후에는 과격 이동 대신 부드럽게만
          map.panTo(ll);
        }
      }
    }
  })();
  </script>
</body>
</html> -->